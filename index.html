<!DOCTYPE html>
<html>
<head>
    <title>Addy Hashtags</title>
    <script src="https://chr15m.github.io/bugout/bugout.min.js"></script>
</head>
<style>
    body {
        display: grid;
        height: 100vh;
        margin: 0;
        place-items: center center;
    }
    div input{
        display: block
    }
    pre {
        font-family: Consolas,monospace;
        font-size: 1em;
    }
    input {
        width: 400px;
    }
</style>
<body>
    <div>
        <pre>
<h1>Addy #Hashtags</h1>

Bookmarks in your browser are boring.

Save website addresses and visit them with custom Addy #hashtags, instead!
        </pre>
    </div>
    <div style="color: orange">
        <input id="hash" type="text" placeholder="#hashtag"><br>
        <input id="link" type="text" placeholder="https://www.google.com"><br>
        <button id="go">Save and Go!</button>
    </div>
    <div>
        <pre>
Visit your saved website by adding your hashtag to the url <span style="color: orange">https://www.addy.pw</span>.

    Example: 
    <span style="color: orange">https://www.addy.pw</span><span style="color: blue">#MemorableHashtag</span>

You can also create new Addy hashtags by typing this in your address bar:

    Example: 
    <span style="color: orange">https://www.addy.pw</span><span style="color: red">?url=https://www.yourcoolurl.com</span><span style="color: blue">#MemorableHashtag</span>
        
Your Addy hashtags are only accessibly from this device, but you can sync/share 
them between devices by scanning this QR code:

    <span id="share-qr"></span>

Or by sharing this link:
    <span id="share-link"></span>
        </pre>
    </div>
</body>
<script>
    let params = new URL(window.location).searchParams;
    let loc = window.location
    let hash = loc.hash;
    let url = params.get("url")

    if(url && hash){
        url = checkUrl(url)
        if(url){
            localStorage.setItem(hash, url)
        }
    }
    if(hash && !url){
        let link = localStorage.getItem(hash)
        if(link){
            link = checkUrl(link)
        }
    }
    let button = document.getElementById("go")
    button.addEventListener("click", () => {
        save()
    })
    function save(){
        let hash = document.getElementById("hash").value
        let link = document.getElementById("link").value 
        link = checkUrl(link)    
        if(hash && link){
            localStorage.setItem(hash, link)
        }
    }
    function checkUrl(url){
        let regEx = /^https?:\/\/(?:www\.)?[-a-zA-Z0-9@:%._\+~#=]{1,256}\.[a-zA-Z0-9()]{1,6}\b([-a-zA-Z0-9()@:%_\+.~#?&//=]*)$/gm;

        if (regEx.test(url)) {
            document.body.innerHTML = 
            `<pre>Redirecting to <span style='color: red'>${url}"</span>  . . .</pre>`
            location.replace(url)
            return url
        } else {
            //alert("Please enter a complete url! (e.g. https://www.example.com)")
        }
    }
    let linkTyping = document.getElementById("link")
    linkTyping.addEventListener("keyup", event => {
        if(event.key == "h"){
            linkTyping.value = "https://"
        }
        if(event.key == "Enter"){
            let hash = document.getElementById("hash").value
            let link = document.getElementById("link").value 
            if(hash && link){
                save()
            } else {
                console.log("No values to save")
            }
        }
    })

    function allStorage() {
        var archive = [],
        keys = Object.keys(localStorage),
        i = 0, key

        for (; key = keys[i]; i++) {
            if(key.charAt(0) == "#"){
                archive.push( {key: key,value: localStorage.getItem(key)})
            }
        }
        console.log(archive)
        return archive
    }

    document.addEventListener('DOMContentLoaded', async () => {
        let site = "https://www.addy.pw"
        let bugout = params.get("b")

        console.log(bugout)

        //var b = new Bugout(bugout || {seed: localStorage.getItem("bugout-server-seed")})
        let address = localStorage.getItem("address")

        var b = new Bugout(bugout || address)       

        if(!address){
            localStorage.setItem("address", b.address())
            address = b.address()
        }

        let shareAddy = `${site}?b=${address}`
        document.getElementById("share-link").innerHTML = `<a href="${shareAddy}">${shareAddy}</a>`
        document.getElementById("share-qr").innerHTML = `<img src="https://api.qrserver.com/v1/create-qr-code/?size=150x150&data=${shareAddy}">`

        //localStorage["bugout-server-seed"] = b.seed;
        b.on("message", (address, message) => {
            console.log("message from", address, "is", message)
            if(message.length > 0){
                console.log("got some stuff to share!")
                message.forEach( (element, index) => {
                    console.log(element.key)
                    localStorage.setItem(element.key, element.value)
                    //console.log(element[index].key)
                });
            }
        });

        // send an encrypted message to a specific client
        //b.send(clientaddress, "Hello!");

        // whenever we see a new client in this swarm
        b.on("seen", (address) => {
            let addys = allStorage()
            b.send(addys);
            console.log("User joined!")
        // e.g. send a message to the client we've seen with this address
        });
    })

</script>
</html>